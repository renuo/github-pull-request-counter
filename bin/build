#!/bin/bash

set -e

# Clean dist directory
rm -rf dist
mkdir -p dist

# Create necessary directories
mkdir -p dist/js/services dist/js/static dist/css

# Copy static files
cp -r src/icons dist/
cp src/manifest.json dist/
cp src/popup.html dist/
cp src/options.html dist/

# Copy JavaScript files
cp src/js/*.js dist/js/ || true
cp src/js/services/*.js dist/js/services/ || true
cp src/js/static/*.js dist/js/static/ || true

# Copy CSS files
cp src/css/*.css dist/css/ || true

# Add testing key to manifest.json for integration tests
if [ "$ENV" = "testing" ]; then
  if [ -z "$EXTENSION_TEST_KEY" ]; then
    echo "Warning: EXTENSION_TEST_KEY not set, skipping key addition to manifest.json"
  else
    echo "Adding testing key to manifest.json..."
    # Create a temporary file with the modified content
    awk -v key="$EXTENSION_TEST_KEY" '
      BEGIN { found=0 }
      /}[[:space:]]*$/ && !found {
        printf "%s,\n  \"key\": \"%s\"\n}\n", substr($0, 1, length($0)-1), key;
        found=1;
        next
      }
      { print }
    ' dist/manifest.json > dist/manifest.json.tmp && mv dist/manifest.json.tmp dist/manifest.json
    
    echo "Updated manifest.json content:"
    cat dist/manifest.json
  fi
fi

# Ensure dist directory is properly set up
echo "Checking dist directory structure..."
ls -la dist/
ls -la dist/js/
ls -la dist/css/
