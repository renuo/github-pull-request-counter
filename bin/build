#!/bin/bash

set -e

# Clean dist directory
rm -rf dist
mkdir -p dist

# Create necessary directories
mkdir -p dist/js/services dist/js/static dist/css

# Copy static files
cp -r src/icons dist/
cp src/manifest.json dist/
cp src/popup.html dist/
cp src/options.html dist/

# Copy JavaScript files
cp src/js/*.js dist/js/ || true
cp src/js/services/*.js dist/js/services/ || true
cp src/js/static/*.js dist/js/static/ || true

# Copy CSS files
cp src/css/*.css dist/css/ || true

# Add testing key to manifest.json for integration tests
if [ "$ENV" = "testing" ]; then
  if [ -z "$EXTENSION_TEST_KEY" ]; then
    echo "Warning: EXTENSION_TEST_KEY not set, skipping key addition to manifest.json"
  else
    # Create a temporary manifest with the testing key and ID
    echo "Adding testing key and ID to manifest.json..."
    jq '. + {"key": "'"$EXTENSION_TEST_KEY"'"}' dist/manifest.json > dist/manifest.json.tmp
  fi
  mv dist/manifest.json.tmp dist/manifest.json
  cat dist/manifest.json
fi

# Ensure dist directory is properly set up
echo "Checking dist directory structure..."
ls -la dist/
ls -la dist/js/
ls -la dist/css/
